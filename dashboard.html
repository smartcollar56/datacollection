<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farm Health Dashboard</title>
  <meta name="theme-color" content="#13171F">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    :root {
      --primary: #13171F;
      --light-green: #E4FFC4;
      --olive-green: #DDE8AC;
      --pink: #FFC1C1;
      --champee: #FFEADC;
      --light-grey: #EFEFF5;
      --sky: #C1EEFF;
      --violet: #C3C1FF;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f6fa;
      color: var(--primary);
      min-height: 100vh;
    }

    /* Modern Dark Navigation */
    .navbar {
      background: linear-gradient(135deg, var(--primary) 0%, #1a1f2e 100%);
      color: white;
      padding: 0 32px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 20px rgba(19, 23, 31, 0.3);
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 2px solid rgba(193, 238, 255, 0.1);
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .nav-logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--light-green) 0%, var(--olive-green) 100%);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      box-shadow: 0 4px 15px rgba(228, 255, 196, 0.3);
      transition: transform 0.3s ease;
    }

    .nav-logo:hover {
      transform: scale(1.1) rotate(5deg);
    }

    .nav-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .nav-tabs {
      display: flex;
      gap: 8px;
      flex: 1;
      justify-content: center;
      max-width: 500px;
      margin: 0 auto;
    }

    .nav-tab {
      padding: 12px 28px;
      border: none;
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.7);
      font-size: 15px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .nav-tab::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%) scaleX(0);
      width: 80%;
      height: 3px;
      background: linear-gradient(90deg, var(--sky), var(--light-green));
      transition: transform 0.3s ease;
    }

    .nav-tab:hover {
      background: rgba(255, 255, 255, 0.15);
      color: white;
    }

    .nav-tab:hover::before {
      transform: translateX(-50%) scaleX(1);
    }

    .nav-tab.active {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      box-shadow: 0 0 0 2px rgba(193, 238, 255, 0.3);
    }

    .nav-tab.active::before {
      transform: translateX(-50%) scaleX(1);
    }

    .nav-user {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--violet), var(--pink));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
    }

    .btn-logout {
      padding: 10px 24px;
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    .btn-logout:hover {
      background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
    }

    /* Main Content */
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 32px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .section-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .section-subtitle {
      font-size: 15px;
      color: #6b7280;
      margin-bottom: 28px;
    }

    /* Filters */
    .filters {
      background: white;
      padding: 20px 24px;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(19, 23, 31, 0.08);
      margin-bottom: 28px;
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      border: 1px solid #e5e7eb;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--primary);
    }

    .filter-select {
      padding: 10px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      color: var(--primary);
      background: #fafafa;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 180px;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--sky);
      background: white;
      box-shadow: 0 0 0 3px rgba(193, 238, 255, 0.15);
    }

    .filter-info {
      flex: 1;
      text-align: right;
      font-size: 13px;
      color: #6b7280;
      font-weight: 600;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(19, 23, 31, 0.08);
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--sky), var(--light-green));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(19, 23, 31, 0.12);
    }

    .stat-card:hover::before {
      transform: scaleX(1);
    }

    .stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .stat-title {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      letter-spacing: 0.3px;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 800;
      color: var(--primary);
      letter-spacing: -1px;
    }

    /* Chart Cards */
    .chart-grid {
      display: grid;
      gap: 24px;
      margin-bottom: 32px;
    }

    .chart-card {
      background: white;
      padding: 28px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(19, 23, 31, 0.08);
      border: 1px solid #e5e7eb;
    }

    .chart-header {
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chart-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
    }

    .chart-badge {
      padding: 6px 14px;
      background: linear-gradient(135deg, var(--light-green), var(--olive-green));
      color: var(--primary);
      font-size: 12px;
      font-weight: 700;
      border-radius: 8px;
      letter-spacing: 0.3px;
    }

    .chart-container {
      position: relative;
      height: 450px;
    }

    /* Data Table */
    .table-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(19, 23, 31, 0.08);
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .table-header {
      padding: 24px 28px;
      border-bottom: 2px solid #e5e7eb;
    }

    .table-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .table-subtitle {
      font-size: 13px;
      color: #6b7280;
    }

    .table-wrapper {
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      padding: 16px 20px;
      text-align: left;
      font-size: 13px;
      font-weight: 700;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e5e7eb;
    }

    td {
      padding: 16px 20px;
      font-size: 14px;
      color: #374151;
      border-bottom: 1px solid #f3f4f6;
      font-weight: 500;
    }

    tbody tr {
      transition: background 0.2s ease;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .navbar {
        padding: 0 16px;
        height: auto;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
      }

      .nav-tabs {
        width: 100%;
        max-width: 100%;
      }

      .nav-tab {
        padding: 10px 16px;
        font-size: 14px;
      }

      .container {
        padding: 16px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .chart-container {
        height: 350px;
      }
    }
  </style>
</head>
<body>
  <!-- Modern Dark Navigation -->
  <nav class="navbar">
    <div class="nav-brand">
      <div class="nav-logo">üêÑ</div>
      <div class="nav-title">Farm Health Dashboard</div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="charts">üìä Charts</button>
      <button class="nav-tab" data-tab="data">üìã Data</button>
    </div>

    <div class="nav-user">
      <div class="user-info">
        <div class="user-avatar">CC</div>
        <div class="user-name" id="userName">CowCollar</div>
      </div>
      <button class="btn-logout" id="btnLogout">Logout</button>
    </div>
  </nav>

  <div class="container">
    <!-- Charts Section -->
    <section class="section active" id="section-charts">
      <h1 class="section-title">üìä Live Analytics</h1>
      <p class="section-subtitle">Real-time monitoring of livestock health metrics</p>

      <!-- Filters -->
      <div class="filters">
        <div class="filter-group">
          <span class="filter-label">üîç Device:</span>
          <select id="deviceFilter" class="filter-select">
            <option value="all">All Devices</option>
          </select>
        </div>
        <div class="filter-group">
          <span class="filter-label">üìÖ Date:</span>
          <select id="dateFilter" class="filter-select">
            <option value="today">Today</option>
          </select>
        </div>
        <div class="filter-info" id="filterInfo">Showing all devices - Today</div>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-title">Avg Temperature</div>
            <div class="stat-icon" style="background: linear-gradient(135deg, var(--pink), var(--champee));">üå°Ô∏è</div>
          </div>
          <div class="stat-value" id="avgTemp">--<span style="font-size: 18px; color: #6b7280;">¬∞C</span></div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-title">Avg Movement</div>
            <div class="stat-icon" style="background: linear-gradient(135deg, var(--sky), var(--violet));">üìà</div>
          </div>
          <div class="stat-value" id="avgMovement">--<span style="font-size: 18px; color: #6b7280;">m/s¬≤</span></div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-title">Active Devices</div>
            <div class="stat-icon" style="background: linear-gradient(135deg, var(--light-green), var(--olive-green));">üì°</div>
          </div>
          <div class="stat-value" id="activeDevices">--</div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-title">Total Readings</div>
            <div class="stat-icon" style="background: linear-gradient(135deg, var(--violet), var(--sky));">üìä</div>
          </div>
          <div class="stat-value" id="totalReadings">--</div>
        </div>
      </div>

      <!-- Charts -->
      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-title">üå°Ô∏è Temperature Trends</div>
            <div class="chart-badge">LIVE</div>
          </div>
          <div class="chart-container">
            <canvas id="temperatureChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-title">üìà Movement Activity (24-Hour)</div>
            <div class="chart-badge">HOURLY</div>
          </div>
          <div class="chart-container">
            <canvas id="movementChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Data Section -->
    <section class="section" id="section-data">
      <h1 class="section-title">üìã Raw Data</h1>
      <p class="section-subtitle">Latest sensor readings from all devices</p>

      <div class="table-card">
        <div class="table-header">
          <div class="table-title">Sensor Data</div>
          <div class="table-subtitle">Showing all readings</div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Device ID</th>
                <th>Temperature (¬∞C)</th>
                <th>Gyro X (m/s¬≤)</th>
                <th>Gyro Y (m/s¬≤)</th>
                <th>Gyro Z (m/s¬≤)</th>
              </tr>
            </thead>
            <tbody id="dataTableBody">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                  Loading data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    // Use relative paths - works on both localhost and Vercel deployment
    const API_BASE = '';
    let selectedDevice = 'all';
    let selectedDate = 'today';
    let allData = [];
    let tempChartInstance = null;
    let movementChartInstance = null;

    // Color palette with tonal variations
    const COLORS = {
      'cow_device_01': { bg: 'rgba(228, 255, 196, 0.8)', border: '#DDE8AC' },
      'cow_device_02': { bg: 'rgba(193, 238, 255, 0.8)', border: '#A8D8E8' },
      'cow_device_03': { bg: 'rgba(255, 193, 193, 0.8)', border: '#FFB4B4' },
      'cow_device_04': { bg: 'rgba(255, 234, 220, 0.8)', border: '#FFDCC0' },
      'cow_device_05': { bg: 'rgba(195, 193, 255, 0.8)', border: '#ABA8FF' },
      'cow_device_06': { bg: 'rgba(221, 232, 172, 0.8)', border: '#C8D98E' },
    };

    // Generate color for any device
    function getDeviceColor(deviceId, index) {
      if (COLORS[deviceId]) return COLORS[deviceId];
      
      // Generate tonal variations for additional devices
      const baseColors = [
        '#E4FFC4', '#C1EEFF', '#FFC1C1', '#FFEADC', '#C3C1FF', '#DDE8AC'
      ];
      const baseColor = baseColors[index % baseColors.length];
      return {
        bg: baseColor + 'CC',
        border: baseColor
      };
    }

    // Check authentication
    if (sessionStorage.getItem('authenticated') !== 'true') {
      window.location.href = '/';
    }

    // Set user name
    const username = sessionStorage.getItem('username') || 'User';
    document.getElementById('userName').textContent = username.charAt(0).toUpperCase() + username.slice(1);

    // Tab switching
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;
        
        // Update active tab
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Show corresponding section
        document.querySelectorAll('.section').forEach(section => {
          section.classList.remove('active');
        });
        document.getElementById(`section-${targetTab}`).classList.add('active');
      });
    });

    // Logout functionality
    document.getElementById('btnLogout').addEventListener('click', () => {
      sessionStorage.clear();
      window.location.href = '/';
    });

    // Device filter
    document.getElementById('deviceFilter').addEventListener('change', (e) => {
      selectedDevice = e.target.value;
      updateDashboard();
    });

    // Date filter
    document.getElementById('dateFilter').addEventListener('change', (e) => {
      selectedDate = e.target.value;
      updateDashboard();
    });

    // Fetch data
    function fetchData() {
      return fetch(API_BASE + '/data')
        .then(res => res.json())
        .then(json => {
          if (json.success && json.data) {
            allData = json.data;
            return json.data;
          }
          return [];
        })
        .catch(err => {
          console.error('Error:', err);
          return [];
        });
    }

    // Update device filter
    function updateDeviceFilter(data) {
      const deviceFilter = document.getElementById('deviceFilter');
      const devices = [...new Set(data.map(d => d.device_id))].sort();
      const currentValue = deviceFilter.value;
      
      deviceFilter.innerHTML = '<option value="all">All Devices</option>';
      devices.forEach(deviceId => {
        const option = document.createElement('option');
        option.value = deviceId;
        option.textContent = deviceId;
        deviceFilter.appendChild(option);
      });
      
      if (currentValue !== 'all' && devices.includes(currentValue)) {
        deviceFilter.value = currentValue;
      }
    }

    // Update date filter
    function updateDateFilter(data) {
      const dateFilter = document.getElementById('dateFilter');
      const uniqueDates = new Set();
      
      // Get today's date string for comparison
      const today = new Date();
      const todayYear = today.getFullYear();
      const todayMonth = String(today.getMonth() + 1).padStart(2, '0');
      const todayDay = String(today.getDate()).padStart(2, '0');
      const todayDateStr = `${todayYear}-${todayMonth}-${todayDay}`;
      
      // Extract unique dates (normalize to local date string YYYY-MM-DD)
      data.forEach(d => {
        const date = new Date(d.timestamp);
        // Create a date string in local timezone to avoid timezone issues
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const localDateStr = `${year}-${month}-${day}`;
        uniqueDates.add(localDateStr);
      });
      
      // Sort dates in descending order (most recent first)
      const sortedDates = Array.from(uniqueDates).sort().reverse();
      const currentValue = dateFilter.value;
      
      dateFilter.innerHTML = '<option value="today">Today</option>';
      sortedDates.forEach(dateStr => {
        // Skip today's date since we already have "Today" option
        if (dateStr === todayDateStr) {
          return;
        }
        
        const option = document.createElement('option');
        option.value = dateStr;
        // Format display as DD.MM.YYYY
        const [year, month, day] = dateStr.split('-');
        option.textContent = `${day}.${month}.${year}`;
        dateFilter.appendChild(option);
      });
      
      if (currentValue !== 'today' && sortedDates.includes(currentValue)) {
        dateFilter.value = currentValue;
      }
    }

    // Filter data by device and date
    function filterData(data) {
      let filtered = data;
      
      // Filter by device
      if (selectedDevice !== 'all') {
        filtered = filtered.filter(d => d.device_id === selectedDevice);
      }
      
      // Filter by date
      if (selectedDate === 'today') {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        filtered = filtered.filter(d => {
          const timestamp = new Date(d.timestamp);
          return timestamp >= today && timestamp < tomorrow;
        });
      } else {
        // Parse the selected date string (YYYY-MM-DD format)
        const [year, month, day] = selectedDate.split('-').map(Number);
        const selectedDateObj = new Date(year, month - 1, day, 0, 0, 0, 0);
        const nextDay = new Date(year, month - 1, day + 1, 0, 0, 0, 0);
        
        filtered = filtered.filter(d => {
          const timestamp = new Date(d.timestamp);
          // Normalize timestamp to local date for comparison
          const localDate = new Date(timestamp.getFullYear(), timestamp.getMonth(), timestamp.getDate(), 0, 0, 0, 0);
          return localDate.getTime() === selectedDateObj.getTime();
        });
      }
      
      return filtered;
    }

    // Update stats
    function updateStats(data) {
      if (!data || data.length === 0) {
        document.getElementById('avgTemp').innerHTML = '--<span style="font-size: 18px; color: #6b7280;">¬∞C</span>';
        document.getElementById('avgMovement').innerHTML = '--<span style="font-size: 18px; color: #6b7280;">m/s¬≤</span>';
        document.getElementById('activeDevices').textContent = '0';
        document.getElementById('totalReadings').textContent = '0';
        return;
      }

      const avgTemp = (data.reduce((sum, d) => sum + d.temperature, 0) / data.length).toFixed(1);
      const avgMovement = (data.reduce((sum, d) => sum + Math.abs(d.gyro_x), 0) / data.length).toFixed(2);
      const activeDevices = new Set(data.map(d => d.device_id)).size;
      const totalReadings = data.length;

      document.getElementById('avgTemp').innerHTML = `${avgTemp}<span style="font-size: 18px; color: #6b7280;">¬∞C</span>`;
      document.getElementById('avgMovement').innerHTML = `${avgMovement}<span style="font-size: 18px; color: #6b7280;">m/s¬≤</span>`;
      document.getElementById('activeDevices').textContent = activeDevices;
      document.getElementById('totalReadings').textContent = totalReadings.toLocaleString();
    }

    // Update table
    function updateTable(data) {
      const tbody = document.getElementById('dataTableBody');
      
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">üì≠ No data available</td></tr>';
        return;
      }

      // Show all readings (most recent first)
      const allReadings = [...data].reverse();
      tbody.innerHTML = allReadings.map(row => {
        const date = new Date(row.timestamp);
        return `<tr>
          <td>${date.toLocaleString()}</td>
          <td><strong>${row.device_id}</strong></td>
          <td>${row.temperature.toFixed(2)}</td>
          <td>${row.gyro_x.toFixed(2)}</td>
          <td>${row.gyro_y.toFixed(2)}</td>
          <td>${row.gyro_z.toFixed(2)}</td>
        </tr>`;
      }).join('');
    }

    // Create 24-hour timeline
    function create24HourTimeline(selectedDateStr) {
      const baseDate = selectedDateStr === 'today' ? new Date() : new Date(selectedDateStr);
      baseDate.setHours(0, 0, 0, 0);
      
      const timeline = [];
      for (let hour = 0; hour < 24; hour++) {
        const time = new Date(baseDate);
        time.setHours(hour, 0, 0, 0);
        timeline.push(time);
      }
      return timeline;
    }

    // Update charts
    function updateCharts(data) {
      if (!data || data.length === 0) {
        document.getElementById('filterInfo').textContent = 'üì≠ No data has been uploaded yet. Waiting for sensor data...';
        if (tempChartInstance) tempChartInstance.destroy();
        if (movementChartInstance) movementChartInstance.destroy();
        return;
      }

      const filteredData = filterData(data);
      const dateDisplay = selectedDate === 'today' ? 'Today' : new Date(selectedDate).toLocaleDateString();
      const deviceDisplay = selectedDevice === 'all' ? 'all devices' : selectedDevice;
      document.getElementById('filterInfo').textContent = `Showing ${deviceDisplay} - ${dateDisplay}`;
      
      if (selectedDevice !== 'all' && filteredData.length === 0) {
        if (tempChartInstance) tempChartInstance.destroy();
        if (movementChartInstance) movementChartInstance.destroy();
        document.getElementById('filterInfo').textContent = `‚ö†Ô∏è Device "${selectedDevice}" was not registered on ${dateDisplay}`;
        return;
      }

      // Group by device
      const dataByDevice = {};
      filteredData.forEach(d => {
        if (!dataByDevice[d.device_id]) {
          dataByDevice[d.device_id] = [];
        }
        dataByDevice[d.device_id].push(d);
      });

      const deviceIds = Object.keys(dataByDevice).sort();

      // Temperature Chart
      const tempDatasets = deviceIds.map((deviceId, idx) => {
        const colors = getDeviceColor(deviceId, idx);
        return {
          label: deviceId,
          data: dataByDevice[deviceId].map(d => ({
            x: new Date(d.timestamp),
            y: d.temperature
          })),
          borderColor: colors.border,
          backgroundColor: colors.bg,
          borderWidth: 3,
          pointRadius: 4,
          pointHoverRadius: 6,
          tension: 0.4
        };
      });

      if (tempChartInstance) tempChartInstance.destroy();
      tempChartInstance = new Chart(document.getElementById('temperatureChart'), {
        type: 'line',
        data: { datasets: tempDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: { 
                font: { size: 13, weight: 'bold' },
                padding: 15,
                usePointStyle: true
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(19, 23, 31, 0.95)',
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 },
              padding: 12,
              cornerRadius: 8
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'minute',
                displayFormats: { minute: 'HH:mm' }
              },
              title: {
                display: true,
                text: 'Time',
                font: { size: 14, weight: 'bold' },
                color: '#374151'
              },
              grid: { color: 'rgba(0, 0, 0, 0.05)' },
              ticks: { 
                font: { size: 12 },
                color: '#6b7280'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Temperature (¬∞C)',
                font: { size: 14, weight: 'bold' },
                color: '#374151'
              },
              grid: { color: 'rgba(0, 0, 0, 0.05)' },
              ticks: { 
                font: { size: 12 },
                color: '#6b7280'
              }
            }
          }
        }
      });

      // Movement Chart - 24 Hour Timeline
      const timeline24h = create24HourTimeline(selectedDate);
      
      const movementDatasets = deviceIds.map((deviceId, idx) => {
        const deviceData = dataByDevice[deviceId];
        const colors = getDeviceColor(deviceId, idx);
        
        const hourlyData = timeline24h.map(hour => {
          const hourEnd = new Date(hour);
          hourEnd.setHours(hour.getHours() + 1);
          
          const pointsInHour = deviceData.filter(d => {
            const timestamp = new Date(d.timestamp);
            return timestamp >= hour && timestamp < hourEnd;
          });
          
          if (pointsInHour.length === 0) {
            return { x: hour, y: null };
          }
          
          const avgMovement = pointsInHour.reduce((sum, d) => sum + Math.abs(d.gyro_x), 0) / pointsInHour.length;
          return { x: hour, y: avgMovement };
        });
        
        return {
          label: deviceId,
          data: hourlyData,
          backgroundColor: colors.bg,
          borderColor: colors.border,
          borderWidth: 2,
          borderRadius: 6,
          spanGaps: false
        };
      });

      if (movementChartInstance) movementChartInstance.destroy();
      movementChartInstance = new Chart(document.getElementById('movementChart'), {
        type: 'bar',
        data: { datasets: movementDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: { 
                font: { size: 13, weight: 'bold' },
                padding: 15,
                usePointStyle: true
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(19, 23, 31, 0.95)',
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 },
              padding: 12,
              cornerRadius: 8,
              callbacks: {
                title: function(context) {
                  const hour = new Date(context[0].parsed.x).getHours();
                  return `${hour.toString().padStart(2, '0')}:00 - ${(hour + 1).toString().padStart(2, '0')}:00`;
                },
                label: function(context) {
                  if (context.parsed.y === null) {
                    return context.dataset.label + ': No data recorded';
                  }
                  return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' m/s¬≤';
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'hour',
                displayFormats: { hour: 'HH:mm' },
                tooltipFormat: 'HH:mm'
              },
              min: timeline24h[0],
              max: timeline24h[23],
              title: {
                display: true,
                text: '24-Hour Timeline (00:00 - 23:59)',
                font: { size: 14, weight: 'bold' },
                color: '#374151'
              },
              grid: { color: 'rgba(0, 0, 0, 0.05)' },
              ticks: { 
                font: { size: 12 },
                color: '#6b7280',
                stepSize: 2
              }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Movement (m/s¬≤)',
                font: { size: 14, weight: 'bold' },
                color: '#374151'
              },
              grid: { color: 'rgba(0, 0, 0, 0.05)' },
              ticks: { 
                font: { size: 12 },
                color: '#6b7280'
              }
            }
          }
        }
      });
    }

    // Main update function
    function updateDashboard() {
      fetchData().then(data => {
        if (!data || data.length === 0) {
          document.getElementById('filterInfo').textContent = 'üì≠ No data has been uploaded yet. Waiting for sensor data...';
          document.getElementById('avgTemp').innerHTML = '--<span style="font-size: 18px; color: #6b7280;">¬∞C</span>';
          document.getElementById('avgMovement').innerHTML = '--<span style="font-size: 18px; color: #6b7280;">m/s¬≤</span>';
          document.getElementById('activeDevices').textContent = '0';
          document.getElementById('totalReadings').textContent = '0';
          
          if (tempChartInstance) tempChartInstance.destroy();
          if (movementChartInstance) movementChartInstance.destroy();
          
          document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">üì≠ No data available. Upload sensor data to see it here.</td></tr>';
          return;
        }
        
        updateDeviceFilter(data);
        updateDateFilter(data);
        const filteredData = filterData(data);
        updateStats(filteredData);
        updateTable(filteredData);
        updateCharts(data);
      });
    }

    // Initial load
    updateDashboard();

    // Auto-refresh every 5 seconds
    setInterval(updateDashboard, 5000);
  </script>
</body>
</html>
